name: Filter Content After Daily Fetch

permissions:
  contents: write

on:
  workflow_run:
    workflows: ["Daily Fetch and Process"]
    types:
      - completed
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  filter-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Configure Git credentials
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Check if fetched-content.txt exists
        run: |
          if [ ! -f fetched-content.txt ]; then
            echo "File fetched-content.txt does not exist. Exiting."
            exit 1
          fi

      - name: Filter content
        run: |
          echo "Filtering content..."
          # æ·»åŠ è°ƒè¯•ä¿¡æ¯
          echo "Sample of fetched content:" && head -n 10 fetched-content.txt
          
          # åˆ›å»ºç­›é€‰åçš„æ–‡ä»¶ï¼Œåˆ é™¤æŒ‡å®šè¡Œå’Œ'å›½å¤–,'ä¹‹åçš„å†…å®¹
          # ä½¿ç”¨æ›´å¥å£®çš„æ–¹å¼å¤„ç†emojiå­—ç¬¦ï¼Œä½¿ç”¨æ‹¬å·åˆ†ç»„æé«˜å¯è¯»æ€§
          awk '{
            # æ£€æŸ¥æ˜¯å¦åŒ…å«'å›½å¤–,'ï¼Œå¦‚æœæ˜¯åˆ™é€€å‡º
            if ($0 ~ /å›½å¤–,/) {
              print "DEBUG: Found 'å›½å¤–,' marker, stopping processing"
              exit
            }
            # è°ƒè¯•ï¼šæ‰“å°å½“å‰è¡Œ
            # print "DEBUG: Processing line: " $0
            
            # è·³è¿‡æŒ‡å®šè¡Œ - ä½¿ç”¨æ›´ç²¾ç¡®çš„åŒ¹é…æ–¹å¼
            if ($0 ~ /^ğŸ†‘å½“å‰æ›´æ–°,#genre#/ || 
                $0 ~ /^ğŸ’8æœˆ6æ—¥,https:\/\/vd2\.bdstatic\.com\/mda-pmrnj7kz4w1j04q0\/576p\/h264\/1703606205600411832\/mda-pmrnj7kz4w1j04q0\.mp4/ || 
                $0 ~ /^ğŸ†‘å…³æ³¨å‘å¯†ç ,#genre#/ ||
                # å°è¯•ä¸åŒçš„åŒ¹é…æ–¹å¼å¤„ç†é¦™æ¸¯emoji
                ($0 ~ /^gateway,#genre#/ || $0 ~ /ğŸ‡­ğŸ‡°.*gateway,#genre#/) ||
                $0 ~ /^å…¬ä¼—å·:æ±Ÿå—åº“æ€»åº“/) {
              # æ·»åŠ è°ƒè¯•ä¿¡æ¯
              print "DEBUG: Skipping line: " $0
              next
            }
            # æ‰“å°å…¶ä»–æ‰€æœ‰è¡Œ
            print
          }' fetched-content.txt > filtered-content.txt
          
          # æ·»åŠ è°ƒè¯•ä¿¡æ¯ï¼Œæ˜¾ç¤ºè¿‡æ»¤ç»“æœ
          echo "Sample of filtered content:" && head -n 10 filtered-content.txt
          echo "Lines skipped by filter:" && grep -c "DEBUG: Skipping line" filtered-content.txt || echo "0"

          # æ£€æŸ¥ç­›é€‰åçš„æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ ! -f filtered-content.txt ]; then
            echo "Filtered file was not created."
            exit 1
          fi

          # æ£€æŸ¥ç­›é€‰åçš„æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s filtered-content.txt ]; then
            echo "Filtered file is empty."
            exit 1
          fi

          echo "Content filtering completed successfully."

      - name: Commit and push filtered content
        run: |
          git add filtered-content.txt
          git commit -m "Add filtered content $(date +'%Y-%m-%d')" || echo "No changes to commit"
          # ä½¿ç”¨GitHub Actionsä»¤ç‰Œè¿›è¡Œæ¨é€
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }} || echo "Push failed due to permissions"
