name: Filter Content After Daily Fetch

permissions:
  contents: write

on:
  workflow_run:
    workflows: ["Daily Fetch and Process"]
    types:
      - completed
  workflow_dispatch:  # 允许手动触发

jobs:
  filter-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Configure Git credentials
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Check if fetched-content.txt exists
        run: |
          if [ ! -f fetched-content.txt ]; then
            echo "File fetched-content.txt does not exist. Exiting."
            exit 1
          fi

      - name: Filter content
        run: |
          echo "Filtering content..."
          # 添加调试信息
          echo "Sample of fetched content:" && head -n 10 fetched-content.txt
          
          # 创建临时调试日志文件
          touch debug_log.txt
          
          # 创建筛选后的文件，删除指定行和'国外,'之后的内容
          # 使用更健壮的方式处理emoji字符，使用括号分组提高可读性
          awk '{
            # 检查是否包含'国外,'，如果是则退出
            if ($0 ~ /国外,/) {
              print "DEBUG: Found '国外,' marker, stopping processing" > "/dev/stderr"
              exit
            }
            
            # 跳过指定行 - 使用更精确的匹配方式
            if ($0 ~ /^🆑当前更新,#genre#/ || 
                $0 ~ /^💎8月6日,https:\/\/vd2\.bdstatic\.com\/mda-pmrnj7kz4w1j04q0\/576p\/h264\/1703606205600411832\/mda-pmrnj7kz4w1j04q0\.mp4/ || 
                $0 ~ /^🆑关注发密码,#genre#/ ||
                # 尝试不同的匹配方式处理香港emoji
                ($0 ~ /^gateway,#genre#/ || $0 ~ /🇭🇰.*gateway,#genre#/) ||
                $0 ~ /^公众号:江南库总库/) {
              # 将调试信息输出到标准错误而不是结果文件
              print "DEBUG: Skipping line: " $0 > "/dev/stderr"
              next
            }
            # 打印其他所有行到结果文件
            print
          }' fetched-content.txt > filtered-content.txt 2> debug_log.txt
          
          # 显示调试信息
          echo "Lines skipped by filter:" && wc -l < debug_log.txt || echo "0"
          echo "Skipped lines:" && cat debug_log.txt
          
          # 添加调试信息，显示过滤结果
          echo "Sample of filtered content:" && head -n 10 filtered-content.txt
          
          # 清理临时文件
          rm debug_log.txt

          # 检查筛选后的文件是否创建成功
          if [ ! -f filtered-content.txt ]; then
            echo "Filtered file was not created."
            exit 1
          fi

          # 检查筛选后的文件是否为空
          if [ ! -s filtered-content.txt ]; then
            echo "Filtered file is empty."
            exit 1
          fi

          echo "Content filtering completed successfully."

      - name: Commit and push filtered content
        run: |
          git add filtered-content.txt
          git commit -m "Add filtered content $(date +'%Y-%m-%d')" || echo "No changes to commit"
          # 使用GitHub Actions令牌进行推送
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }} || echo "Push failed due to permissions"
