name: Filter Content After Daily Fetch

permissions:
  contents: write

on:
  workflow_run:
    workflows: ["Daily Fetch and Process"]
    types:
      - completed
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  filter-content:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Configure Git credentials
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

      - name: Check if fetched-content.txt exists
        run: |
          if [ ! -f fetched-content.txt ]; then
            echo "File fetched-content.txt does not exist. Exiting."
            exit 1
          fi

      - name: Filter content
        run: |
          echo "Filtering content..."
          
          # åˆ›å»ºç­›é€‰åçš„æ–‡ä»¶ï¼Œåˆ é™¤æŒ‡å®šè¡Œå’Œ'å›½å¤–,'ä¹‹åçš„å†…å®¹
          # å®Œå…¨ç§»é™¤æ‰€æœ‰è°ƒè¯•è¾“å‡ºï¼Œç¡®ä¿åªè¾“å‡ºéœ€è¦ä¿ç•™çš„è¡Œ
          awk '{
            # æ£€æŸ¥æ˜¯å¦åŒ…å«'å›½å¤–,'ï¼Œå¦‚æœæ˜¯åˆ™é€€å‡º
            if ($0 ~ /å›½å¤–,/) {
              exit
            }
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«å¹¿æ’­ç”µå°ç›¸å…³å†…å®¹ï¼Œå¦‚æœæ˜¯åˆ™é€€å‡ºï¼ˆåˆ é™¤è¯¥æ¨¡å¼åŠå…¶åé¢æ‰€æœ‰å†…å®¹ï¼‰
            if ($0 ~ /ğŸ“£å¹¿æ’­ç”µå°,#genre#/ || $0 ~ /å¹¿æ’­ç”µå°,#genre#/) {
              exit
            }
            
            # æ£€æŸ¥æ˜¯å¦åŒ…å«ç”µå½±é¢‘é“ç›¸å…³å†…å®¹ï¼Œå¦‚æœæ˜¯åˆ™é€€å‡ºï¼ˆåˆ é™¤è¯¥æ¨¡å¼åŠå…¶åé¢æ‰€æœ‰å†…å®¹ï¼‰
            if ($0 ~ /ğŸ‡¨ğŸ‡³ç”µå½±é¢‘é“,#genre#/) {
              exit
            }
            
            # è·³è¿‡æŒ‡å®šè¡Œ - åŒ…å«å„ç§éœ€è¦è¿‡æ»¤çš„æ¨¡å¼
            if ($0 ~ /^ğŸ†‘å½“å‰æ›´æ–°,#genre#/ || 
                $0 ~ /^ğŸ’8æœˆ6æ—¥,https:\/\/vd2\.bdstatic\.com\/mda-pmrnj7kz4w1j04q0\/576p\/h264\/1703606205600411832\/mda-pmrnj7kz4w1j04q0\.mp4/ || 
                $0 ~ /^ğŸ†‘å…³æ³¨å‘å¯†ç ,#genre#/ ||
                $0 ~ /ğŸ‡­ğŸ‡°gateway,#genre#/ ||
                $0 ~ /^å…¬ä¼—å·:æ±Ÿå—åº“æ€»åº“/) {
              next
            }
            # åªæ‰“å°éœ€è¦ä¿ç•™çš„è¡Œ
            print
          }' fetched-content.txt > filtered-content.txt
          
          # ç®€å•æ£€æŸ¥è¿‡æ»¤ç»“æœ
          echo "Filtering completed."

          # æ£€æŸ¥ç­›é€‰åçš„æ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
          if [ ! -f filtered-content.txt ]; then
            echo "Filtered file was not created."
            exit 1
          fi

          # æ£€æŸ¥ç­›é€‰åçš„æ–‡ä»¶æ˜¯å¦ä¸ºç©º
          if [ ! -s filtered-content.txt ]; then
            echo "Filtered file is empty."
            exit 1
          fi

          echo "Content filtering completed successfully."

      - name: Commit and push filtered content
        run: |
          git add filtered-content.txt
          git commit -m "Add filtered content $(date +'%Y-%m-%d')" || echo "No changes to commit"
          # ä½¿ç”¨GitHub Actionsä»¤ç‰Œè¿›è¡Œæ¨é€
          git push https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git HEAD:${{ github.ref }} || echo "Push failed due to permissions"
